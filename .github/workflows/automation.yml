name: DPDC Usage Data Collection

on:
  schedule:
    # Run Twice daily (9 AM & 9 PM)
    ## Cron Format Quick Reference:
    # * * * * *
    # │ │ │ │ │
    # │ │ │ │ └─── Day of week (0-6, Sunday=0)
    # │ │ │ └───── Month (1-12)
    # │ │ └─────── Day of month (1-31)
    # │ └───────── Hour (0-23)
    # └─────────── Minute (0-59)
    - cron: '0 9,21 * * *'
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  fetch-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y chromium-browser chromium-chromedriver
    
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run automation
      env:
        GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
        CUSTOMER_NUMBER: ${{ secrets.CUSTOMER_NUMBER }}
        SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
      run: |
        python dpdc_automation.py
    
    - name: Upload debug files on failure
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: failure-debug-${{ github.run_number }}
        path: |
          *.png
          *.html
          *.txt
        retention-days: 3
    
    - name: Upload success screenshots
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: success-run-${{ github.run_number }}
        path: |
          *.png
        retention-days: 1
